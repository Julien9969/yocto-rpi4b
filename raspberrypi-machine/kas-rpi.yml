# https://kas.readthedocs.io/en/latest/userguide/ 
# Every file needs to contain a header, that provides kas with information
# about the context of this file.
header:
  # The `version` entry in the header describes for which configuration
  # format version this file was created for. It is used by kas to figure
  # out if it is compatible with this file. The version is an integer that
  # is increased on every format change.
  version: 19
# The machine as it is written into the `local.conf` of bitbake.
machine: raspberrypi4-64
target: core-image-base
# The distro name as it is written into the `local.conf` of bitbake.
distro: poky
repos:
  # This entry includes the repository where the config file is located
  # to the bblayers.conf:
  # meta-custom:
  # Here we include a list of layers from the poky repository to the
  # bblayers.conf:
  poky:
    url: "https://git.yoctoproject.org/git/poky"
    branch: kirkstone # scarthgap
    # commit: b8f8125f05e8ece078ba6bf01eebb2900cf2f9bf # scarthgap commit
    layers:
      meta:
      meta-poky:
      meta-yocto-bsp:

  meta-raspberrypi:
    url: "https://git.yoctoproject.org/git/meta-raspberrypi"
    branch: kirkstone
    layers:
      .:

  meta-myfandriver:
    path: meta-myfandriver
    layers:
      .:

local_conf_header:
  build-data-and-cache: |
    BB_HASHSERVE_UPSTREAM = "wss://hashserv.yoctoproject.org/ws"
    SSTATE_MIRRORS ?= "file://.* http://sstate.yoctoproject.org/all/PATH;downloadfilename=PATH"
    BB_HASHSERVE = "auto"
    # BB_SIGNATURE_HANDLER = "OEEquivHash"
    
    SOURCES = "/home/trizotto/Desktop/yocto-rpi4b/raspberrypi-machine/sources"
    SSTATE_DIR = "${SOURCES}/sstate-cache"
    DL_DIR ?= "${SOURCES}/downloads"
    TMPDIR = "${SOURCES}/tmp"
    
  init-system: |
    DISTRO_FEATURES:append = " systemd"
    VIRTUAL-RUNTIME_init_manager = "systemd"
    VIRTUAL-RUNTIME_initscripts = "systemd-compat-units"

  rpi-specific: |
    # IMAGE_FSTYPES += "wic wic.bmap"
    ENABLE_I2C = "1"
    RPI_EXTRA_CONFIG = "dtoverlay=disable-bt"

  image-conf: |
    IMAGE_FEATURES += " ssh-server-openssh"
    EXTRA_IMAGE_FEATURES ?= "debug-tweaks allow-root-login"

    # bitbake-layers show-recipes git
    IMAGE_INSTALL:append = " git python3 openssh openssh-sshd"
    SYSTEMD_AUTO_ENABLE = "enable"
    SYSTEMD_SERVICE:ssh = "sshd.service"

  kernel-support: |
    IMAGE_INSTALL:append = " kernel-dev kernel-devsrc"

  fan: |
    KERNEL_MODULE_AUTOLOAD += "myfan_driver"
    IMAGE_INSTALL:append = " myfan-driver"
  
  other: |
    RM_OLD_IMAGE = "1"
    INHERIT += "rm_work"
